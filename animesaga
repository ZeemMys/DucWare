-- ⚠️ Khởi tạo thư viện Fluent GUI
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- ✅ Luôn đợi GUI player có sẵn
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- ✅ Tạo cửa sổ GUI
local Window = Fluent:CreateWindow({
    Title = "DucWare",
    SubTitle = "by Duck (Thanks To Fluent GUI)",
    TabWidth = 160,
    Size = UDim2.fromOffset(570, 440),
    Acrylic = true,
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Lobby = Window:AddTab({ Title = "Lobby", Icon = "box" }),
    Game = Window:AddTab({ Title = "Game", Icon = "swords" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

Fluent:Notify({
    Title = "Chào mừng",
    Content = "AnimeSaga Script ĐÃ CHẠY",
    Duration = 6
})

------------------ LOBBY --------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SellEvent = ReplicatedStorage:FindFirstChild("Event")
    and ReplicatedStorage.Event:FindFirstChild("ItemIven")
    and ReplicatedStorage.Event.ItemIven:FindFirstChild("Sell")

local selectedRarities = {}
local autoSellRunning = false

Tabs.Lobby:AddDropdown("RarityDropdown", {
    Title = "Chọn độ hiếm để Auto Sell",
    Values = {"Rare", "Epic", "Legendary", "Mythic"},
    Multi = true,
    Default = {},
    Callback = function(values)
        selectedRarities = {}
        for _, rarity in ipairs(values) do
            selectedRarities[rarity] = true
        end
    end
})

Tabs.Lobby:AddToggle("AutoSellToggle", {
    Title = "Auto Sell",
    Default = false,
    Callback = function(state)
        autoSellRunning = state
        if state then
            task.spawn(function()
                while autoSellRunning do
                    for rarity in pairs(selectedRarities) do
                        if SellEvent then
                            pcall(function()
                                SellEvent:FireServer(rarity)
                            end)
                        end
                    end
                    task.wait(2)
                end
            end)
        end
    end
})

------------------ GAME TAB --------------------

local autoStart = false
local autoFarm = false

Tabs.Game:AddToggle("AutoStartToggle", {
    Title = "Auto Start",
    Default = false,
    Callback = function(state)
        autoStart = state
        if state then
            task.spawn(function()
                while autoStart do
                    local btn = PlayerGui:FindFirstChild("RoomUi")
                        and PlayerGui.RoomUi:FindFirstChild("Ready")
                        and PlayerGui.RoomUi.Ready:FindFirstChild("Frame")
                        and PlayerGui.RoomUi.Ready.Frame:FindFirstChild("StartButton")

                    if btn and btn:IsA("ImageButton") and btn.Visible and btn.AutoButtonColor then
                        pcall(function()
                            firesignal(btn.MouseButton1Click)
                        end)
                    end
                    task.wait(2)
                end
            end)
        end
    end
})

Tabs.Game:AddToggle("AutoFarmToggle", {
    Title = "Auto Farm",
    Default = false,
    Callback = function(state)
        autoFarm = state
        if state then
            task.spawn(function()
                while autoFarm do
                    local mobsFolder = workspace:FindFirstChild("Enemy") and workspace.Enemy:FindFirstChild("Mob")
                    local myChar = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                    local myHRP = myChar:WaitForChild("HumanoidRootPart", 5)

                    if mobsFolder and myHRP then
                        for _, mob in ipairs(mobsFolder:GetChildren()) do
                            local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                            local hum = mob:FindFirstChild("Humanoid")
                            if mobHRP and hum and hum.Health > 0 then
                                myChar:PivotTo(mobHRP.CFrame * CFrame.new(0, 0, -3))

                                -- Skill spam (Z, X, C)
                                keypress(0x5A) wait(0.05) keyrelease(0x5A)
                                keypress(0x58) wait(0.05) keyrelease(0x58)
                                keypress(0x43) wait(0.05) keyrelease(0x43)

                                task.wait(0.3)
                            end
                        end
                    end

                    task.wait(0.4)
                end
            end)
        end
    end
})

---------------- SETTINGS -----------------

InterfaceManager:SetLibrary(Fluent)
SaveManager:SetLibrary(Fluent)

SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/AnimeSaga")

InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)

Fluent:Notify({
    Title = "✅ DucWare đã chạy",
    Content = "Mọi chức năng đã load xong!",
    Duration = 6
})

SaveManager:LoadAutoloadConfig()
